# 使用`dnSpy`调试.NET程序

## 一、工具介绍及下载地址

- `dnSpy`是一个.NET调试器和.NET程序集编辑器。即使没有任何可用的源代码，也可以使用它来编辑和调试程序集。有以下功能

  1. 可对.NET的程序集进行反编译
  2. 可直接对反编译后的.NET程序集进行修改并重新编译,无需源代码
  3. **可通过直接运行.NET的可执行程序或者附加正在运行的.NET程序进行调试,无需源代码(本文分享的内容)**

- 工具下载地址

  [Release v6.1.8 · dnSpy/dnSpy · GitHub](https://github.com/dnSpy/dnSpy/releases/tag/v6.1.8)

  ![image-20230310095427918](images\image-20230310095427918.png)

  

- 下载完成后解压对应压缩包就可以直接运行`dnSpy`,无需另外安装

  ![image-20230310100716813](images\image-20230310100716813.png)

## 二、`dnSpy`调试桌面程序

### 通过`dnSpy`附加正在运行的.NET程序

#### 步骤:

1. 选择 调试=>附加到进程菜单

   ![image-20230310105921194](images\image-20230310105921194.png)

2. 在弹出的附加到进程的列表中选择对应的.NET程序

   **注:****如果可执行程序是用管理员身份运行的,则`dnSpy`也需要以管理员的身份运行,否则附加到进程的列表会找不到对应程序名称**

   ![image-20230310110310703](images\image-20230310110310703.png)

3. 打开模块窗口及监视窗口

   **注:以下步骤是在附加进程后才能设置**

   1)打开模块窗口

      选择 调试=>窗口=>模块菜单

   ![image-20230310112910408](images\image-20230310112910408.png)

   

   2)打开监视窗口

     选择  调试=>窗口=>监视菜单

   ![image-20230310113648072](images\image-20230310113648072.png)

#### 开始调试

##### 设置断点及调试

本例以点击打印单据按钮执行的方法为例

- 搜索对应的程序集加载到程序集资源管理器并找到对应的方法名称,并设置断点

  ![image-20230310115807609](images\image-20230310115807609.png)

  注:

  1)在上面第②步中,如果知道程序集的文件位置,可通过拖拽的方式直接拖进去,但是当`dnSpy`是以管理员身份运行时是不允许拖拽进去的

  2）由于`dnSpy`是通过反编译的方式展现的,代码和源码会有差异,而且可能想要设置断点的那一行无法进行设置,这是只能多试几行,看哪一行可以进行设置断点

- 当程序执行并命中断点后的界面如下(调试的快捷键与Visual Studio一致)

  ![image-20230310144247940](images\image-20230310144247940.png)

- 监视窗口

  ![image-20230310150023150](images\image-20230310150023150.png)

  ![image-20230310145652692](images\image-20230310145652692.png)

- 当不知道对应操作的代码在哪个程序集以及方法时,可以先借助`DotTrace Performance`找到对应的程序集及方法名,再到**模块**页面搜索对应的程序集并设置断点

  ![image-20230310151443171](images\image-20230310151443171.png)

  ![image-20230310151652095](images\image-20230310151652095.png)

  

##### 异常设置

​    **通过异常设置,当附加程序程序并有触发到对应的异常,会自动跳转到报错方法的对应代码行**

1. 选择 调试=>窗口=>异常设置 菜单

   ![image-20230310150511142](images\image-20230310150511142.png)

2. 设置异常监测

   ![image-20230310152313401](images\image-20230310152313401.png)

3. 当附加程序程序并触发对应的异常时,断点会命中报错方法对应的行(例子中演示空指针异常)

   ![image-20230310152858926](images\image-20230310152858926.png)

   ![image-20230310153044084](images\image-20230310153044084.png)

   

### 通过`dnSpy`直接启动.NET可执行程序

#### 步骤:

1. 点击启动按钮,选择对应的调试引擎(默认选择.NET Framework)
2. 选择可执行程序所在路径
3. 如果可执行程序需要命令行参数可在参数框填写对应参数(可选步骤)
4. 点击确定按钮启动程序

![image-20230310102605813](images\image-20230310102605813.png)

#### 说明

- 调试引擎中选择.NET Framework与.NET的区别

  1).NET Framework用于调试.NET Framework4.8及以下版本的.NET程序

  2).NET用于调试.NET5及以上版本的.NET程序(或者.NET Core3.0及以前的版本)

  ![image-20230310103611912](images\image-20230310103611912.png)

- 中断于入口点用于程序启动时断点会自动停留在主函数,**方便调试从框架启动到打开登录界面之间有报错,来不及附加进程调试的场景**

  ![image-20230310104513926](images\image-20230310104513926.png)

  ![image-20230310104652097](images\image-20230310104652097.png)

## 三、附加调试IIS服务

- 选择 调试=>附加到进程菜单

![image-20230310160205660](images\image-20230310160205660.png)

**注:需确定应用程序池是否启用32位程序,如果是,需要使用32位的`dnSpy`,反之使用64位的,使用不正确的版本在附加到程序界面会无法找到程序**

![image-20230310163649895](images\image-20230310163649895.png)

- 在附加到进程界面找到w3wp.exe相关的进程,在命令行列找到要调试的服务,并附加进程

![image-20230310162928333](images\image-20230310162928333.png)

![image-20230310161944321](images\image-20230310161944321.png)

