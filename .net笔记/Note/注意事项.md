# 注意事项

## Newtonsoft.Json时间格式化

```c#
public class Student
{
    public string StuId { get; set; }
    public string StuName { get; set; }
    public DateTime date { get; set; }

}
```

**以上Student类型中date序列化出来的时间是默认是ISO8601格式**

![image-20211130221130099](images\image-20211130221130099.png)

解决方式

- 自定义一个时间格式化

```C#
IsoDateTimeConverter timeConverter = new IsoDateTimeConverter();
//这里使用自定义日期格式，如果不使用的话，默认是ISO8601格式 
timeConverter.DateTimeFormat = "yyyy-MM-dd HH:mm:ss";
string json = JsonConvert.SerializeObject(student, timeConverter);
```

## WebApi中的时间格式化

WebApi或mvc中DateTime的序列化也是ISO8601格式

解决方式

- nuget引用Microsoft.AspNetCore.Mvc.NewtonsoftJson包

  ```powershell
  Install-Package Microsoft.AspNetCore.Mvc.NewtonsoftJson -Version 6.0.0
  ```

- 在注册控制器是指定时间格式

  ```C#
  builder.Services.AddControllers().AddNewtonsoftJson(options=>
  {
      options.SerializerSettings.DateFormatString = "yyyy-MM-dd HH:mm:ss";
  });
  ```

![image-20211130221727803](images\image-20211130221727803.png)

## WebApi通过数据流获取请求的原始报文问题

在.net core比较高版本中以下用法会报错,旧版本可以使用

```C#
Stream body = context.HttpContext.Request.Body;
body.Position = 0;//从头开始读
using (StreamReader reader = new StreamReader(body))
{
   string json = reader.ReadToEnd();
}
```

![image-20211130222831889](images\image-20211130222831889.png)

解决方法:

- 中间件注册中加上以下代码即可,要在终结点中间件之前添加

  ```C#
  app.Use((context, next) =>
  {
      context.Request.EnableBuffering();
      return next();
  });
  ```

  ![image-20211130223108079](images\image-20211130223108079.png)

- .net core3.0之后中读取请求流流使用同步方法会报错，要使用异步方法读取数据流

  ![image-20211130223401314](images\image-20211130223401314.png)

正确用法

```C#
Stream body = context.HttpContext.Request.Body;
body.Position = 0;//从头开始读
using (StreamReader reader = new StreamReader(body))
{
    string json = reader.ReadToEndAsync().Result;
}
```

![image-20211130223725622](images\image-20211130223725622.png)

